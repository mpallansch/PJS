function Simulation(pSimName,pServerRoot,pState,pInputQueue,pDrawFunction){function initialize(){bindPageUnload(),admin?showModal("Start Simulation",sendStartCommand):(waitForStart(),showModal("Waiting for admin to start simulation"))}function bindPageUnload(){$(window).bind("beforeunload",function(){return null!==pid?(setTimeout(function(){showModal("Join Simulation",register)},50),stopProcess(),$.ajax({type:"GET",url:serverRoot+"unregister",data:{id:pid}}),pid=null,"You have now exited the simulation."):void 0})}function startProcess(){state.time=0,loop=setInterval(function(){computeGVT(),getEvents(),draw(state),inputIndex<inputQueue.length&&(inputQueue[inputIndex].previousState=state,state.time=parseInt(inputQueue[inputIndex].timeStamp),state=inputQueue[inputIndex].execute(inputQueue[inputIndex],state),inputQueue[inputIndex].processed=!0,inputIndex++);for(var e=0;inputIndex>e;e++)inputQueue[e].timeStamp<GVT&&(inputQueue.splice(e,1),inputIndex--,e--)},interval)}function stopProcess(){clearInterval(loop)}function getEvents(){$.ajax({type:"GET",url:serverRoot+"getevents",data:{id:pid},success:function(data){data.forEach(function(element,index){eval("element.execute = "+element.execute+";");var event=new Event(element.timeStamp,element.execute,pid);if(element.antiMessage){for(var found=!1,i=inputIndex;i<inputQueue.length;i++)if(inputQueue[i].timeStamp===event.timeStamp&&inputQueue[i].execute.toString()===event.execute.toString()){inputQueue.splice(i,1),found=!0;break}if(!found){for(var i=0;inputIndex>i;i++)if(inputQueue[i].timeStamp===event.timeStamp&&inputQueue[i].execute.toString()===event.execute.toString()){rollback(event.timeStamp),inputQueue.splice(inputIndex,1),found=!0;break}found||cancelledQueue.push(event)}}else cancelledQueue.forEach(function(e,t){return e.timeStamp===event.timeStamp&&e.execute.toString()===event.execute.toString()?void cancelledQueue.splice(t,1):void 0}),inputQueue[inputQueue.length-1].timeStamp>event.timestamp?(rollback(event.timestamp),inputQueue.splice(inputIndex,0,event)):inputQueue.push(event)})},error:function(e,t){stopProcess(),console.log(t)},timeout:interval})}function rollback(e){for(var t=inputIndex-1,n=inputQueue[t];n.timeStamp>=e;)state=n.previousState,n.previousState=void 0,n.outputQueue.forEach(function(e,t){sendMessage(e)}),outputQueue=[],n.processed=!1,inputIndex--,t--,n=inputQueue[t]}function computeGVT(){var e=Number.MAX_VALUE;inputQueue.forEach(function(t,n){t.timeStamp<e&&(e=t.timeStamp),t.outputQueue.forEach(function(t,n){t.event.timeStamp<e&&(e=t.event.timeStamp)})}),$.ajax({type:"GET",url:serverRoot+"GVT",data:{id:pid,GVT:e},success:function(e){GVT=parseInt(e)},error:function(e,t){stopProcess(),console.log(t),console.log("Unable to send GVT request")}})}function waitForStart(){loop=setInterval(function(){$.ajax({type:"GET",url:serverRoot+"started",success:function(e){"true"===e&&(clearInterval(loop),removeModal(),startProcess())},timeout:interval})},interval)}function sendStartCommand(){$.ajax({type:"GET",url:serverRoot+"start",success:function(e){"OK"!==e&&console.log("Unable to start simulation")},error:function(e,t){stopProcess(),console.log(t),console.log("Unable to start simulation")}}),startProcess()}function showModal(e,t){var n=document.createElement("div");n.setAttribute("id","modal"),n.setAttribute("style","position: fixed; width: 100%; height: 100%; top: 0; left: 0; text-align: center; background-color: gray; z-index: 100;"),n.innerHTML='<div style="position: relative; top: 45%;'+(void 0===t?"":" color: blue; cursor: pointer; text-decoration: underline;")+'">'+e+"</div>",t&&(n.onclick=function(){removeModal(),t()}),document.body.appendChild(n)}function removeModal(){var e=document.getElementById("modal");document.body.removeChild(e)}function register(){$.ajax({type:"GET",url:serverRoot+"register",data:{name:name},success:function(e){pid=e.id,admin=e.admin,initialize()},error:function(e,t){stopProcess(),alert(t)}})}var sim=this,pid=null,name=pSimName,admin=!1,serverRoot=pServerRoot,state=pState,inputQueue=pInputQueue,cancelledQueue=[],draw=pDrawFunction,loop,interval=1e3,GVT=0,inputIndex=0,roster={};this.sendMessage=function(e,t,n){$.ajax({type:"GET",url:serverRoot+"event",data:{destination:e,timeStamp:t.timeStamp,execute:t.execute.toString(),anti:n},success:function(e){"OK"!==e&&(console.log("Failed to send event: "),console.log(t))},error:function(e,n){stopProcess(),console.log(n),console.log("Failed to send event: "),console.log(t)}})},this.addEvent=function(e){inputQueue[inputQueue.length-1].timeStamp>e.timestamp?(rollback(e.timestamp),inputQueue.splice(inputIndex,0,e)):inputQueue.push(e)},this.getPID=function(){return pid},register()}function Event(e,t,n){this.timeStamp=e,this.execute=t,this.processed=!1,this.previousState=void 0,this.outputQueue=[],this.destination=n,this.scheduleEvent=function(e,t){void 0===this.destination||this.destination===e.getPID()?e.addEvent(t):(e.sendMessage(this.destination,t,!1),this.outputQueue.push({destination:this.destination,event:t}))}}